certificates:
  metrics.hosting.kitkube.dk:
    issuer:
      name: letsencrypt-prod
      kind: ClusterIssuer
    dnsNames:
      - testkunde-metrics.hosting.kitkube.dk
  alerts.hosting.kitkube.dk:
    issuer:
      name: letsencrypt-prod
      kind: ClusterIssuer
    dnsNames:
      - testkunde-alerts.hosting.kitkube.dk
  prometheus.hosting.kitkube.dk:
    issuer:
      name: letsencrypt-prod
      kind: ClusterIssuer
    dnsNames:
      - testkunde-prometheus.hosting.kitkube.dk

securedservices:
  prometheus-alertmanager:
    ingress:
      annotations:
        kubernetes.io/ingress.class: nginx
        # Cluster intern: 192.168.0.0/24
        # KIT: 80.208.24.138
        nginx.ingress.kubernetes.io/whitelist-source-range: 192.168.0.0/24,80.208.24.138
      hosts:
        - testkunde-alerts.hosting.kitkube.dk
      tls:
        - hosts:
           - testkunde-alerts.hosting.kitkube.dk
          secretName: testkunde-alerts.hosting.kitkube.dk
  prometheus-server:
    ingress:
      annotations:
        kubernetes.io/ingress.class: nginx
        # Cluster intern: 192.168.0.0/24
        # KIT: 80.208.24.138
        nginx.ingress.kubernetes.io/whitelist-source-range: 192.168.0.0/24,80.208.24.138
      hosts:
        - testkunde-prometheus.hosting.kitkube.dk
      tls:
        - hosts:
           - testkunde-prometheus.hosting.kitkube.dk
          secretName: testkunde-prometheus.hosting.kitkube.dk

prometheus:
  resources:
    limits:
      cpu: 10m
      memory: 32Mi
    requests:
      cpu: 10m
      memory: 32Mi
  server:
    sidecarContainers:
      alerts-loader:
        env:
          - name: LABEL
            value: prometheusAlerts
          - name: FOLDER
            value: /tmp/
          - name: REQ_URL
            value: 'http://127.0.0.1:9090/-/reload'
          - name: REQ_METHOD
            value: POST
          - name: NAMESPACE
            value: ALL
        image: 'kiwigrid/k8s-sidecar:0.1.20'
        imagePullPolicy: IfNotPresent
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
          - mountPath: /tmp
            name: alerts-volume
      gatekeeper:
        args:
          - '--listen=0.0.0.0:8001'
          - '--enable-authorization-header=true'
          - '--upstream-url=http://localhost:9090'
          - '--client-id=prometheus'
          - '--discovery-url=https://keycloak.hosting.kitkube.dk/auth/realms/Infrastructure'
          - '--secure-cookie=false'
          - '--enable-default-deny=true'
          - '--client-secret=$(KCPClientOIDC)'
          - '--cookie-domain=.hosting.kitkube.dk'
          - '--resources=uri=/*'
          - '--resources=uri=/api/*|white-listed=true'
          - '--resources=uri=/alerts|white-listed=true'
          - '--resources=uri=/static/*|white-listed=true'
        env:
          - name: KCPClientOIDC
            valueFrom:
              secretKeyRef:
                key: secret
                name: keycloakproxyclient
        image: 'keycloak/keycloak-gatekeeper:5.0.0'
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 8001
            name: container-port
            protocol: TCP
    persistentVolume:
      enabled: true
      storageClass: longhorn
    ingress:
      enabled: false

  alertmanager:
    resources:
      limits:
        cpu: 10m
        memory: 32Mi
      requests:
        cpu: 10m
        memory: 32Mi
    persistentVolume:
      enabled: true
      storageClass: longhorn
    ingress:
      enabled: false
    sidecarContainers:
      - args:
          - '--listen=0.0.0.0:8001'
          - '--enable-authorization-header=true'
          - '--upstream-url=http://localhost:9090'
          - '--client-id=prometheus'
          - '--discovery-url=https://keycloak.hosting.kitkube.dk/auth/realms/Infrastructure'
          - '--secure-cookie=false'
          - '--enable-default-deny=true'
          - '--client-secret=$(KCPClientOIDC)'
          - '--cookie-domain=.hosting.kitkube.dk'
          - '--resources=uri=/*'
          - '--resources=uri=/api/*|white-listed=true'
          - '--resources=uri=/alerts|white-listed=true'
          - '--resources=uri=/static/*|white-listed=true'
        env:
          - name: KCPClientOIDC
            valueFrom:
              secretKeyRef:
                key: secret
                name: keycloakproxyclient
        image: 'keycloak/keycloak-gatekeeper:5.0.0'
        imagePullPolicy: IfNotPresent
        name: gatekeeper
        ports:
          - containerPort: 8001
            name: container-port
            protocol: TCP

  pushgateway:
    resources:
      limits:
        cpu: 10m
        memory: 32Mi
      requests:
        cpu: 10m
        memory: 32Mi
    extraArgs:
      persistence.file: /data/metrics
      persistence.interval: 30s
    persistentVolume:
      enabled: true
      storageClass: longhorn
    ingress:
      enabled: true
      annotations:
        kubernetes.io/ingress.class: nginx
        # Cluster intern: 192.168.0.0/24
        # KIT: 80.208.24.138
        nginx.ingress.kubernetes.io/whitelist-source-range: 192.168.0.0/24,80.208.24.138
      hosts:
        - testkunde-metrics.hosting.kitkube.dk
      tls:
        - hosts:
            - testkunde-metrics.hosting.kitkube.dk
          secretName: testkunde-metrics.hosting.kitkube.dk
